import{d as K,c as $,r as _e,e as a,f as u,k as n,w as t,bf as o,j as h,y as R,A as d,x as p,Y as _,q as I,l as de,h as D,u as ne,F as te,H as v,b as pe}from"./@vue-a481fc63.js";import{u as me}from"./vuex-44de225f.js";import{u as ge,b as fe}from"./vue-router-e5a2430e.js";import{J as ve,O as ke,P as ye,Q as he,u as we,f as be,_ as X,R as $e}from"./index-cb47660d.js";import{K as ee,k as Ie,N as Se,O as Ce,Q as se,U as Me,r as A,s as ze,t as qe,X as T,Y as Oe,Z as U,_ as B,R as V}from"./@vicons-f0266f88.js";import{F as Re,j as m,o as Te,M as Ae,l as Fe,e as ae,P as oe,T as Ne,O as Pe,U as We,a as je,G as Ue,Q as Be,J as Ve,k as De,H as He}from"./naive-ui-eecf2ec3.js";import{_ as Le}from"./whisper-7f52b83e.js";import{_ as Qe}from"./main-nav.vue_vue_type_style_index_0_lang-830cbb44.js";import{W as Je}from"./v3-infinite-loading-2c58ec2f.js";import"./axios-4a70c6fc.js";import"./moment-2ab8298d.js";/* empty css               */import"./seemly-76b7b838.js";import"./vueuc-7c8d4b48.js";import"./evtd-b614532e.js";import"./@css-render-7124a1a5.js";import"./vooks-6d99783e.js";import"./vdirs-b0483831.js";import"./@juggle-41516555.js";import"./css-render-6a5c5852.js";import"./@emotion-8a8e73f6.js";import"./lodash-es-8412e618.js";import"./treemate-25c27bff.js";import"./async-validator-dee29e8b.js";import"./date-fns-975a2d8f.js";const Ye={class:"sender-wrap"},Ee={key:0,class:"nickname"},Ge={key:0,class:"username"},Ke={key:1,class:"nickname"},Xe={key:0,class:"username"},Ze={key:2,class:"nickname"},xe={class:"timestamp"},es={class:"timestamp-txt"},ss={key:0,class:"brief-content"},ns={key:1,class:"whisper-content-wrap"},ts={key:2,class:"requesting-friend-wrap"},as={key:2,class:"status-info"},os={key:3,class:"status-info"},ls="https://assets.paopao.info/public/avatar/default/admin.png",rs=K({__name:"message-item",props:{message:{}},emits:["send-whisper","reload"],setup(H,{emit:w}){const c=H,g=ge(),l=me(),M=Re(),b=$(()=>l.state.desktopModelShow?"已发送":"私信已发送"),k=$(()=>l.state.desktopModelShow?"已接收":"私信已接收"),f=e=>()=>D(m,null,{default:()=>D(e)}),F=$(()=>{let e=[{label:"私信",key:"whisper",icon:f(A)}],s=c.message.type==4&&c.message.sender_user_id==l.state.userInfo.id?c.message.receiver_user:c.message.sender_user;return l.state.userInfo.id!=s.id&&(s.is_following?e.push({label:"取消关注",key:"unfollow",icon:f(ze)}):e.push({label:"关注",key:"follow",icon:f(qe)})),e}),z=e=>{let s=e.type==4&&e.sender_user_id==l.state.userInfo.id?e.receiver_user:e.sender_user;M.success({title:"提示",content:"确定"+(s.is_following?"取消关注":"关注")+"该用户吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{s.is_following?we({user_id:s.id}).then(y=>{window.$message.success("操作成功"),s.is_following=!1,setTimeout(()=>{w("reload")},50)}).catch(y=>{}):be({user_id:s.id}).then(y=>{window.$message.success("关注成功"),s.is_following=!0,setTimeout(()=>{w("reload")},50)}).catch(y=>{})}})},N=e=>{switch(e){case"whisper":const s=c.message;if(s.type!=99){let y=s.type==4&&s.sender_user_id==l.state.userInfo.id?s.receiver_user:s.sender_user;w("send-whisper",y)}break;case"follow":case"unfollow":z(c.message);break}},S=$(()=>c.message.type!==4||c.message.sender_user_id!==l.state.userInfo.id),i=$(()=>c.message.type==4&&c.message.receiver_user_id==l.state.userInfo.id),P=$(()=>c.message.type==4&&c.message.sender_user_id==l.state.userInfo.id),W=e=>{C(e),(e.type===1||e.type===2||e.type===3)&&(e.post&&e.post.id>0?g.push({name:"post",query:{id:e.post_id}}):window.$message.error("该动态已被删除"))},L=e=>{C(e),ke({user_id:e.sender_user_id}).then(s=>{e.reply_id=2,window.$message.success("已同意添加好友")}).catch(s=>{console.log(s)})},Q=e=>{C(e),ye({user_id:e.sender_user_id}).then(s=>{e.reply_id=3,window.$message.success("已拒绝添加好友")}).catch(s=>{console.log(s)})},C=e=>{c.message.receiver_user_id==l.state.userInfo.id&&e.is_read===0&&he({id:e.id}).then(s=>{e.is_read=1}).catch(s=>{console.log(s)})};return(e,s)=>{const y=Te,r=_e("router-link"),j=Ae,J=Fe,Y=ae,E=oe,q=Ne,G=Pe;return a(),u("div",{class:de(["message-item",{unread:S.value&&e.message.is_read===0}]),onClick:s[5]||(s[5]=O=>C(e.message))},[n(G,{"content-indented":""},{avatar:t(()=>[n(y,{round:"",size:30,src:e.message.type==4&&e.message.sender_user_id==o(l).state.userInfo.id?e.message.receiver_user.avatar:e.message.sender_user.id>0?e.message.sender_user.avatar:ls},null,8,["src"])]),header:t(()=>[h("div",Ye,[e.message.type!=4&&e.message.sender_user.id>0||i.value?(a(),u("span",Ee,[n(r,{onClick:s[0]||(s[0]=R(()=>{},["stop"])),class:"username-link",to:{name:"user",query:{s:e.message.sender_user.username}}},{default:t(()=>[d(p(e.message.sender_user.nickname),1)]),_:1},8,["to"]),o(l).state.desktopModelShow?(a(),u("span",Ge," @"+p(e.message.sender_user.username),1)):_("",!0)])):P.value?(a(),u("span",Ke,[n(r,{onClick:s[1]||(s[1]=R(()=>{},["stop"])),class:"username-link",to:{name:"user",query:{s:e.message.receiver_user.username}}},{default:t(()=>[d(p(e.message.receiver_user.nickname),1)]),_:1},8,["to"]),o(l).state.desktopModelShow?(a(),u("span",Xe," @"+p(e.message.receiver_user.username),1)):_("",!0)])):(a(),u("span",Ze," 系统 ")),e.message.type==4&&o(l).state.desktopModelShow?(a(),I(j,{key:3,class:"top-tag",type:"success",size:"small",round:""},{default:t(()=>[d(" 私信 ")]),_:1})):_("",!0),P.value?(a(),I(j,{key:4,class:"top-tag",type:"info",size:"small",round:""},{icon:t(()=>[n(o(m),{component:o(ee)},null,8,["component"])]),default:t(()=>[d(p(b.value)+" ",1)]),_:1})):_("",!0),e.message.type==4&&e.message.receiver_user_id==o(l).state.userInfo.id?(a(),I(j,{key:5,class:"top-tag",type:"warning",size:"small",round:""},{icon:t(()=>[n(o(m),{component:o(ee)},null,8,["component"])]),default:t(()=>[d(p(k.value)+" ",1)]),_:1})):_("",!0)])]),"header-extra":t(()=>[h("span",xe,[S.value&&e.message.is_read===0?(a(),I(J,{key:0,dot:"",processing:""})):_("",!0),h("span",es,p(o(ve)(e.message.created_on)),1),n(E,{placement:"bottom-end",trigger:"click",size:"small",options:F.value,onSelect:N},{default:t(()=>[n(Y,{quaternary:"",circle:""},{icon:t(()=>[n(o(m),null,{default:t(()=>[n(o(Ie))]),_:1})]),_:1})]),_:1},8,["options"])])]),description:t(()=>[n(q,{"show-icon":!1,class:"brief-wrap",type:!S.value||e.message.is_read>0?"default":"success"},{default:t(()=>[e.message.type!=4?(a(),u("div",ss,[d(p(e.message.brief)+" ",1),e.message.type===1||e.message.type===2||e.message.type===3?(a(),u("span",{key:0,onClick:s[2]||(s[2]=R(O=>W(e.message),["stop"])),class:"hash-link view-link"},[n(o(m),null,{default:t(()=>[n(o(Se))]),_:1}),d(" 查看详情 ")])):_("",!0)])):_("",!0),e.message.type===4?(a(),u("div",ns,p(e.message.content),1)):_("",!0),e.message.type===5?(a(),u("div",ts,[d(p(e.message.content)+" ",1),e.message.reply_id===1?(a(),u("span",{key:0,onClick:s[3]||(s[3]=R(O=>L(e.message),["stop"])),class:"hash-link view-link"},[n(o(m),null,{default:t(()=>[n(o(Ce))]),_:1}),d(" 同意 ")])):_("",!0),e.message.reply_id===1?(a(),u("span",{key:1,onClick:s[4]||(s[4]=R(O=>Q(e.message),["stop"])),class:"hash-link view-link"},[n(o(m),null,{default:t(()=>[n(o(se))]),_:1}),d(" 拒绝 ")])):_("",!0),e.message.reply_id===2?(a(),u("span",as,[n(o(m),null,{default:t(()=>[n(o(Me))]),_:1}),d(" 已同意 ")])):_("",!0),e.message.reply_id===3?(a(),u("span",os,[n(o(m),null,{default:t(()=>[n(o(se))]),_:1}),d(" 已拒绝 ")])):_("",!0)])):_("",!0)]),_:1},8,["type"])]),_:1})],2)}}});const is=X(rs,[["__scopeId","data-v-529aa194"]]),us={class:"content"},cs=K({__name:"message-skeleton",props:{num:{default:1}},setup(H){return(w,c)=>{const g=We;return a(!0),u(te,null,ne(new Array(w.num),l=>(a(),u("div",{class:"skeleton-item",key:l},[h("div",us,[n(g,{text:"",repeat:2}),n(g,{text:"",style:{width:"60%"}})])]))),128)}}});const _s=X(cs,[["__scopeId","data-v-01d2e871"]]),ds={key:0,class:"skeleton-wrap"},ps={key:1},ms={class:"title title-action"},gs={class:"title title-filter"},fs={key:0,class:"empty-wrap"},vs={key:1},ks={class:"load-more-wrap"},ys={class:"load-more-spinner"},hs=K({__name:"Messages",setup(H){const w=fe(),c=v(!1),g=v(!1),l=v(+w.query.p||1),M=v(20),b=v(0),k=v([]),f=v("所有消息"),F=v("all"),z=v(!1),N=v({id:0,avatar:"",username:"",nickname:"",is_admin:!1,is_friend:!0,is_following:!1,created_on:0,follows:0,followings:0,status:1}),S=()=>{g.value=!1,l.value=1,b.value=0,k.value=[]},i=r=>()=>D(m,null,{default:()=>D(r)}),P=$(()=>{let r;switch(f.value){case"所有消息":r=[{label:"系统消息",key:"system",icon:i(B)},{label:"我的私信",key:"whisper",icon:i(A)},{label:"好友申请",key:"requesting",icon:i(V)},{label:"未读消息",key:"unread",icon:i(T)}];break;case"系统消息":r=[{label:"所有消息",key:"all",icon:i(U)},{label:"我的私信",key:"whisper",icon:i(A)},{label:"好友申请",key:"requesting",icon:i(V)},{label:"未读消息",key:"unread",icon:i(T)}];break;case"我的私信":r=[{label:"所有消息",key:"all",icon:i(U)},{label:"系统消息",key:"system",icon:i(B)},{label:"好友申请",key:"requesting",icon:i(V)},{label:"未读消息",key:"unread",icon:i(T)}];break;case"好友申请":r=[{label:"所有消息",key:"all",icon:i(U)},{label:"系统消息",key:"system",icon:i(B)},{label:"我的私信",key:"whisper",icon:i(A)},{label:"未读消息",key:"unread",icon:i(T)}];break;case"未读消息":r=[{label:"所有消息",key:"all",icon:i(U)},{label:"系统消息",key:"system",icon:i(B)},{label:"我的私信",key:"whisper",icon:i(A)},{label:"好友申请",key:"requesting",icon:i(V)}];break;default:r=[];break}return r}),W=r=>{switch(r){case"all":f.value="所有消息";break;case"system":f.value="系统消息";break;case"whisper":f.value="我的私信";break;case"requesting":f.value="好友申请";break;case"unread":f.value="未读消息";break}F.value=r,S(),s()},L=()=>{W("unread")},Q=()=>{S(),s()},C=r=>{N.value=r,z.value=!0},e=()=>{z.value=!1},s=()=>{c.value=!0,$e({style:F.value,page:l.value,page_size:M.value}).then(r=>{c.value=!1,r.list.length===0&&(g.value=!0),l.value>1?k.value=k.value.concat(r.list):(k.value=r.list,window.scrollTo(0,0)),b.value=Math.ceil(r.pager.total_rows/M.value)}).catch(r=>{c.value=!1,l.value>1&&l.value--})},y=()=>{l.value<b.value||b.value==0?(g.value=!1,l.value++,s()):g.value=!0};return pe(()=>{s()}),(r,j)=>{const J=Qe,Y=Le,E=_s,q=ae,G=Be,O=oe,Z=je,le=Ve,re=is,ie=He,ue=Ue,ce=De;return a(),u("div",null,[n(J,{title:"消息"}),n(ue,{class:"main-content-wrap messages-wrap",bordered:""},{default:t(()=>[n(Y,{show:z.value,user:N.value,onSuccess:e},null,8,["show","user"]),c.value&&k.value.length===0?(a(),u("div",ds,[n(E,{num:M.value},null,8,["num"])])):(a(),u("div",ps,[n(Z,{justify:"space-between"},{default:t(()=>[h("div",ms,[n(q,{text:"",size:"small",onClick:L},{icon:t(()=>[n(o(m),null,{default:t(()=>[n(o(T))]),_:1})]),default:t(()=>[d(" 0 条未读 ")]),_:1}),n(G,{vertical:""}),n(q,{text:"",size:"small",onClick:Q},{default:t(()=>[d("全标已读")]),_:1})]),h("div",gs,[n(O,{placement:"bottom-end",trigger:"click",size:"small",options:P.value,onSelect:W},{default:t(()=>[n(q,{text:""},{icon:t(()=>[n(o(m),null,{default:t(()=>[n(o(Oe))]),_:1})]),default:t(()=>[d(" "+p(f.value),1)]),_:1})]),_:1},8,["options"])])]),_:1}),k.value.length===0?(a(),u("div",fs,[n(le,{size:"large",description:"暂无数据"})])):(a(),u("div",vs,[(a(!0),u(te,null,ne(k.value,x=>(a(),I(ie,{key:x.id},{default:t(()=>[n(re,{message:x,onSendWhisper:C,onReload:s},null,8,["message"])]),_:2},1024))),128))]))]))]),_:1}),b.value>0?(a(),I(Z,{key:0,justify:"center"},{default:t(()=>[n(o(Je),{class:"load-more",slots:{complete:"没有更多消息了",error:"加载出错"},onInfinite:y},{spinner:t(()=>[h("div",ks,[g.value?_("",!0):(a(),I(ce,{key:0,size:14})),h("span",ys,p(g.value?"没有更多消息了":"加载更多"),1)])]),_:1})]),_:1})):_("",!0)])}}});const Js=X(hs,[["__scopeId","data-v-77b4139c"]]);export{Js as default};
